<!DOCTYPE html>
<html lang="en">
  <head>
    <title>CSH Vote</title>
    <!-- <link rel="stylesheet" href="https://themeswitcher.csh.rit.edu/api/get" /> -->
    <link
      rel="stylesheet"
      href="https://assets.csh.rit.edu/csh-material-bootstrap/4.3.1/dist/csh-material-bootstrap.min.css"
      media="screen"
    />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">    

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    {{ template "nav" . }}

    <div class="container main p-5">
      <h2 style="white-space: normal; word-wrap: break-word;">{{ .ShortDescription }}</h2>
      {{ if .LongDescription }}
      <h4>{{ .LongDescription | MakeLinks }}</h4>
      {{ end }}

      <br />
      <br />

      {{ if and $.IsHidden $.IsOpen }}
      <div id="results">
        <h4>Results will be available once the poll closes</h4>
      </div>
      {{ else }}
      {{/* Displays information about required quorum and number of voters */}}
      <div id="quorum-info">
        <h5>Number of Eligible Voters: {{ len .EligibleVoters }}</h5>
        <div id="votes-needed-for-quorum">
          {{/* This works currently because quorum type can only be set if gatekeep is required */}}
          {{ if not .Gatekeep }}
            <h5>No quorum required for this poll.</h5>
          {{ else }}
            <h5>Quorum Type: {{ .Quorum }}%</h5>
            <h5>Votes Needed For Quorum: {{ .VotesNeededForQuorum }}</h5>
          {{ end }}
          <br/>
          <br/>
        </div>
      </div>
      <div id="results">
        {{ range $i, $val := .Results }}
          {{ if eq $.VoteType "ranked" }}
          <h4>Round {{ $i | inc }}</h4>
          {{ end }}
          {{ range $option, $count := $val }}
          <div id="{{ $option }}" style="font-size: 1.25rem; line-height: 1.25">
            {{ $option }}: {{ $count }}
          </div>
          <br />
          {{ end }}
        {{ end }}
      </div>
      {{ end }}
      {{ if and (.CanModify) (not .IsHidden) }}
      <br />
      <br />
      <form action="/poll/{{ .Id }}/hide" method="POST">
        <button type="submit" class="btn btn-danger">Hide Votes</button>
      </form>
      {{ end }}
      {{ if and (and (.CanModify) (.IsOpen)) (not .Gatekeep) }}
      <br />
      <br />
      <form action="/poll/{{ .Id }}/close" method="POST">
        <button type="submit" class="btn btn-primary">End Poll</button>
      </form>
      {{ end }}
    </div>
    <script>
      let eventSource = new EventSource("/stream/{{ .Id }}");

      eventSource.addEventListener("{{ .Id }}", function (event) {
        let data = JSON.parse(event.data);
        for (let option in data) {
          let count = data[option];
          let element = document.getElementById(option);
          if (element == null) {
            let newElement = document.createElement("div");
            newElement.id = option;
            newElement.style = "font-size: 1.25rem; line-height: 1.25";
            newElement.innerText = option + ": " + count;
            document.getElementById("results").appendChild(newElement);
          }
          element.innerText = option + ": " + count;
        }
      });
    </script>
  </body>
</html>
